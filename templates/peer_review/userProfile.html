{% extends "peer_review/base.html" %}
{% load staticfiles %}

{% block extrahead %}
    <title>User Profile</title>
{% endblock extrahead %}

{% block context %}
    <div class="container">
        <h1>{{ user.name }} {{ user.surname }}</h1>

        <div id="accordion">
            <div class="card my-3">
                <div class="card-header" data-toggle="collapse" data-parent="#accordion" data-target="#collapseTwo">
                    User's Rounds <b class="caret"></b>
                </div>

                <div id="collapseTwo" class="collapse show" data-parent="#accordion">
                    <div class="card-body">
                        <table class="table" id="userRoundsTable" data-pk="{{ user.pk }}" data-csrf="{{ csrf_token }}">
                            <thead>
                                <tr>
                                    <th>Round</th>
                                    <th>Team</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        $(document).ready(function() {
            $("#title").val("{{ user.title }}");
            $("#status").val("{{ user.status }}");

            var userRoundsTable = $("#userRoundsTable").DataTable({
                "orderClasses": false,
                "columnDefs": [{
                    "orderable": true,
                    "searchable": true,
                    "render": function(data, type, full, meta){
                        return  '<select class="form-control status">'+
                                '    <option value="NA" class="NA">Not attempted</option>'+
                                '    <option value="IP" class="IP">In progress</option>'+
                                '    <option value="C" class="C">Completed</option>'+
                                '</select>';
                    },
                    "targets": [2]
                }]
            });



            var pk = $("#userRoundsTable").data("pk");
            var token = $("#userRoundsTable").data("csrf");

            var data = {
                "pk": pk,
                "csrfmiddlewaretoken": token
            };

            $.ajax({
                type: 'POST',
                url: '/maintainTeam/getTeams/',
                data: data,
                dataType: 'json',
                success: function(data) {
                    var table = $("#userRoundsTable").DataTable();
                    table.clear().draw();

                    $.each(data, function(index, value) {
                        if(value.team != "emptyTeam") {
                            var row = table.row.add([
                                "<form class='roundRedirect' action='/maintainTeam/' method='POST'>" +
                                "{% csrf_token %}" +
                                "<input type='hidden' name='roundPk' value='" + value.roundPk + "'>" +
                                "<a href='#' id='viewRound'>" + value.round + "</a>" +
                                "</form>",
                                value.team,
                            ]).draw(false).node();

                            $(row).attr("id", value.teamId);
                            $(row).find("." + value.status).attr("selected", "selected");
                        }
                    });
                }
            })
        });

        $("#updateUser").on("click", function() {
            var pk = $(this).data("pk");
            var token = "{{ csrf_token }}";

            var data = {
                'user_id': $("#userName").val(),
                'title': $("#title").val(),
                'initials': $("#initials").val(),
                'name': $("#firstName").val(),
                'surname': $("#surname").val(),
                'cell': $("#cellNumber").val(),
                'email': $("#email").val(),
                'status': $("#status").val(),
                "csrfmiddlewaretoken": token
            };

            $.ajax({
                type: 'POST',
                url: '/userAdmin/update/' + pk,
                data: data,
                success: function() {
                    alert("Updated");
                }
            });
        });

        $("#userRoundsTable").on("click", "#viewRound", function(e) {
            e.preventDefault();
            $(this).parent().submit();
        });

        $("#userRoundsTable").on('change', '.status', function() {
            var row = $(this).parents('tr');
            var id = $(row).attr("id");

            $.ajax({
                type: "GET",
                url: "/maintainTeam/changeTeamStatus/" + id + "/" + $(this).val(),
                success: function(data) {
                }
            });
        });
    </script>
{% endblock context %}